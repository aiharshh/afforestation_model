{% extends "base.html" %}
{% block content %}
<section class="dashboard">
  <aside class="panel">
    <h2>Map Inputs</h2>
    <form method="POST" class="form" id="mapForm">
      <label>
        Species
        <select name="species" required>
          {% for s in species_list %}
            <option value="{{ s }}" {% if s == species %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </label>

      <label>
        Years
        <input type="number" min="1" max="100" name="years" value="{{ years }}" required />
      </label>

      <label>
        Trees planted
        <input type="number" min="1" step="1" name="trees" value="{{ trees }}" required />
      </label>

      <label>
        Latitude
        <input type="number" step="0.000001" name="lat" value="{{ lat }}" required />
      </label>

      <label>
        Longitude
        <input type="number" step="0.000001" name="lon" value="{{ lon }}" required />
      </label>

      <button type="button" class="btn mini" id="useGeo">Use my location</button>
      <button type="submit" class="btn">Update Map</button>
      <a href="{{ url_for('app_page') }}" class="btn mini">← Back</a>

      <p class="muted" style="margin-top:8px;">
        Tip: Click anywhere on the map to drop a pin. Drag the pin to fine-tune location — the latitude/longitude fields update automatically.
      </p>
    </form>

    {% if error %}
      <div class="error">{{ error }}</div>
    {% endif %}

    {% if stats %}
      <div class="panel-sec">
        <h3>Summary</h3>
        <p class="muted">
          {{ stats.species }} • {{ stats.years }} yrs • {{ stats.trees }} trees<br/>
          Trees alive: <b>{{ stats.trees_alive }}</b><br/>
          Yearly CO₂ (t): <b>{{ stats.co2_year_t }}</b><br/>
          Cumulative CO₂ (t): <b>{{ stats.co2_cum_t }}</b>
        </p>

        {% if stats.climate_multiplier %}
          <p class="muted">
            Climate @ location → MAT: <b>{{ stats.mat_c }}°C</b>,
            MAP: <b>{{ stats.map_mm }} mm</b><br/>
            Temp factor: <b>{{ stats.temp_factor }}</b>,
            Rain factor: <b>{{ stats.rain_factor }}</b><br/>
            Applied climate multiplier: <b>{{ stats.climate_multiplier }}</b>
          </p>
        {% endif %}
      </div>
    {% endif %}
  </aside>

  <section class="main">
    <div class="card">
      <h2>Plantation Map</h2>
      <div class="mapwrap">{{ map_html|safe }}</div>

      <script>
        (function () {
          const form = document.getElementById('mapForm');
          const latInput = form.querySelector('input[name="lat"]');
          const lonInput = form.querySelector('input[name="lon"]');

          function updateInputs(lat, lng) {
            latInput.value = Number(lat).toFixed(6);
            lonInput.value = Number(lng).toFixed(6);
          }

          const iframe = document.querySelector('.mapwrap iframe');
          if (!iframe) return;

          iframe.addEventListener('load', () => {
            const iwin = iframe.contentWindow;
            const idoc = iframe.contentDocument || iwin.document;
            if (!iwin || !idoc) return;

            const map = iwin.{{ map_name }};
            const L = iwin.L;

            const initLat = parseFloat(latInput.value);
            const initLon = parseFloat(lonInput.value);
            let userMarker = L.marker([initLat, initLon], { draggable: true }).addTo(map);

            userMarker.on('dragend', (ev) => {
              const p = ev.target.getLatLng();
              updateInputs(p.lat, p.lng);
            });

            map.on('click', (e) => {
              if (userMarker) { map.removeLayer(userMarker); }
              userMarker = L.marker(e.latlng, { draggable: true }).addTo(map);
              updateInputs(e.latlng.lat, e.latlng.lng);

              userMarker.on('dragend', (ev) => {
                const p = ev.target.getLatLng();
                updateInputs(p.lat, p.lng);
              });
            });

            const geoBtn = document.getElementById('useGeo');
            if (geoBtn) {
              geoBtn.addEventListener('click', () => {
                if (!navigator.geolocation) {
                  alert('Geolocation not supported by this browser');
                  return;
                }
                navigator.geolocation.getCurrentPosition(pos => {
                  const { latitude, longitude } = pos.coords;
                  updateInputs(latitude, longitude);

                  if (userMarker) { map.removeLayer(userMarker); }
                  userMarker = L.marker([latitude, longitude], { draggable: true }).addTo(map);

                  userMarker.on('dragend', (ev) => {
                    const p = ev.target.getLatLng();
                    updateInputs(p.lat, p.lng);
                  });

                  map.setView([latitude, longitude], 12);
                }, err => {
                  alert('Could not get location: ' + err.message);
                });
              });
            }
          });
        })();
      </script>
    </div>
  </section>
</section>
{% endblock %}
